# 大业主充值扣费流程


## 文档

* [充值](http://git.corp.anjuke.com/site/ajk-paycenter-doc/browse/master/DEV/apidoc.md#2.%E8%8E%B7%E5%8F%96%E5%85%85%E5%80%BC%E9%A1%B5%E9%9D%A2%E4%B8%B4%E6%97%B6%E4%BC%9A%E8%AF%9D%E5%AF%86%E9%92%A5)
* [扣费](http://git.corp.anjuke.com/_broker_java_api/doc/browse/master/API-Document/threeNetTrade/api.md#%E6%89%A3%E8%B4%B9%EF%BC%88%E7%AB%9E%E4%BB%B7%E7%BB%93%E7%AE%97%EF%BC%89)

## 充值流程

* 充值页面，用户填入金额，提交表单
* 生成合同编号，处理充值金额和参数，生成充值秘钥(参考充值接口文档)，301到充值页面，带入需要的参数
* 用户完成充值，支付中心回调，前台直接跳转到充值成功页面
* 后台回调，记录充值日志，写入金蝶k3系统


问题

* 还有第一笔的免费充值记录
* 前后台回调url是否一样，如何区分
* 合同编号如何传递
* 充值记录要记录哪些数据

## 扣费流程
* 400服务发起请求，包括通话时长，号码等信息
* 过滤服务判断是否需要扣费，记录日志，生成扣费信息
    * 经纪人电话库在哪，(job从经纪人表同步到黑名单库里面)
* 请求扣费接口，获得结果
* 根据扣费结果关联合同编号，记录日志

问题
* 如何关联合同编号(需要单独设计，包括付费，退费)
* 如何确保扣费操作执行有且只有一次

## 合同表设计

400的每个call会传递一个唯一的id，这个ID需要在所有的扣费相关表里面记录这个ID，作为唯一的凭证

* 一个表记录所有充值记录，合同编号，充值编号等
* 一个表记录账号所有的扣款、退费日志，都需要带上唯一ID
* 一个表记录合同的余额状态。发生扣款时，ID从小往大，逐个获取余额不为0的合同，执行扣款操作，如果扣款额度不足，则继续扣下一个合同号

## 扣费设计

* 400回调请求进队列(是否有唯一ID？)
* 起job读取队列，生成信息，记录唯一ID，写入扣费记录表，带上唯一ID直接请求扣费接口(根据文档，重复扣款会失败)
* 根据扣费结果返回的ID，记录扣费请求日志(每个请求一个记录)。根据请求结果，计算合同号，回写扣费记录(有可能一个扣费会关联两个合同号)

### 扣费api

问题

* user\_id 和 acount\_id？
* reqId 是全局唯一，还是只要我这个 appId 下面的唯一