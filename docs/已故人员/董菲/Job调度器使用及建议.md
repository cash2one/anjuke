#Job调度器使用及建议

## 环境

* pg drone.dev.anjuke.com
* 线上 drone.corp.anjuke.com

使用域账号登陆

## 功能

* 通过执行本地命令的方式执行job
* 支持手动触发，Cron定时触发，常驻job
* job失败报警，执行报告

## 手动和定时 Job

http://drone.dev.anjuke.com/scheduler/job

* Drone 分组, 用来选择 job 执行的机器组
* job 描述和 job 分组, 业务上区分, 方便搜索
* 执行命令, 能够成功执行的命令行命令
* Cron 表达式, 和 linux crontab 的区别是第一位是秒
* 告警方式: 失败和执行报告
* 邮件订阅：如果需要接收邮件，选择是即可。之前是只有创建者会收到邮件，现在只要任何人登陆，选择邮件订阅就能够收取邮件

### 手动和定时 Job 的子 Job

* 点击 Job 页面上的加号图表
* 子 Job 会在该 Job 执行成功以后自动执行

## Job 触发记录

job每次执行都会有触发记录，包括job提交时间，job开始执行时间，job结束时间
job的执行状态

job执行状态包括

* 排队
* 执行中
* 成功
* 失败(exitcode!=1)
* kill(exitcode==-9)
* 重复提交和取消执行(该Job已经在执行中时，后续的提交都会被取消)

## Job 日志

* Job的标准输出(stdout)和错误输出(stderr)都会被记录下来，写入job平台的日志系统中
* Job每次触发都有对应的日志记录
* 日志可以进行搜索
* 可以查看该Job的所有执行记录的汇总日志

## 常驻 Job

* 字段和定时Job类似
* 执行方式是，一旦进入运行状态，系统会立刻提交一次执行。当执行结束以后，系统记录执行状态，然后继续提交下一次执行。同时系统会保证同一时间同一个job只会执行一次。
* Job选择了暂停状态后，会立刻强制停止当前正在执行的job(kill -9)
* 每次执行出错或者订阅了执行报告都会发送邮件
* 日志查看和定时Job类似

## Job 编写建议

* 尽可能写可以多次重复执行的Job
* 数据如果有标志位标记是否处理过，一定要在数据整个处理完成以后再更新标志位，而不是一开始获取到数据的时候更新(包括游标，AMQP的ack)
* Job的中间状态和结果不要读写任何本地文件，可以通过现有的游标表, db, redis, memcache来记录状态。结果是文件的可以写入HBase/HDFS
* Job的日志输出到命令行，尽量不要写本地日志文件，后期还可以直接搜索
* 常驻Job避免内存溢出，可以在执行一段时间后退出
* 常驻Job单次执行时间不要太短，如果时效性要求不高，可以用定时Job，每几分钟执行一次。比如说检查db中的状态，没有数据job就立刻退出，这种要么加sleep，要么改成定时的
* 如果需要套while true的脚本，建议使用job-script/while_true.sh


## Drone 的结构

![](http://pic1.ajkimg.com/display/origin/09efe7ff5777db535216940b3ee80cc5.jpg)

* Web 端根据规则将 job 提交到对应的 group 的队列中
* 该 group 下的 Worker 监听对应的队列, 获取 job 并执行
* 执行过程中 Worker 会直接将 job 的标准输出写入日志系统中, 供前台查询
* 执行完成后 Worker 再将执行信息返回给 Web 端
* 每个 Job 都会有心跳和超时检测, 超时后会有对应的超时处理(邮件通知, 常驻 Job 会立刻再次提交处理)

